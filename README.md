# ADK to Dify ä¸­é—´ä»¶é€‚é…å™¨

ä¸€ä¸ªé«˜æ€§èƒ½çš„ Python ä¸­é—´ä»¶æœåŠ¡ï¼Œç”¨äºå°† Google Agent Development Kit (ADK) çš„è‡ªå®šä¹‰ REST/SSE æ¥å£è½¬æ¢ä¸º OpenAI å…¼å®¹çš„ API æ ¼å¼ï¼Œå®ç°ä¸ Dify å¹³å°çš„æ— ç¼é›†æˆã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP/SSE     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP/SSE     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚                 â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚                 â”‚
â”‚   Dify å¹³å°      â”‚                 â”‚  FastAPI ä¸­é—´ä»¶  â”‚                 â”‚   ADK åç«¯       â”‚
â”‚                 â”‚                 â”‚                 â”‚                 â”‚                 â”‚
â”‚  OpenAI æ ¼å¼     â”‚                 â”‚  åè®®è½¬æ¢å±‚       â”‚                 â”‚  è‡ªå®šä¹‰ API      â”‚
â”‚  å¤šæ¨¡æ€æ”¯æŒ      â”‚                 â”‚  å¤šæ¨¡æ€å¤„ç†       â”‚                 â”‚  æµå¼å“åº”        â”‚
â”‚                 â”‚   <â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                 â”‚   <â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    JSON/SSE     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    JSON/SSE     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. FastAPI ä¸­é—´ä»¶å±‚ (`app/main.py`)
- **åŠŸèƒ½**: æ¥æ”¶ Dify çš„ OpenAI æ ¼å¼è¯·æ±‚
- **ç‰¹æ€§**: 
  - OpenAI å…¼å®¹çš„ `/v1/chat/completions` ç«¯ç‚¹
  - æ”¯æŒæµå¼å’Œéæµå¼å“åº”
  - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
  - CORS æ”¯æŒå’Œ API Key è®¤è¯

#### 2. ADK å®¢æˆ·ç«¯ (`app/adk_client.py`)
- **åŠŸèƒ½**: ä¸ ADK åç«¯é€šä¿¡çš„æ ¸å¿ƒå®¢æˆ·ç«¯
- **ç‰¹æ€§**:
  - è‡ªåŠ¨ä¼šè¯ç®¡ç†
  - æ™ºèƒ½å†…å®¹å»é‡
  - æµå¼å“åº”æ¨¡æ‹Ÿ
  - å®Œæ•´çš„é”™è¯¯å¤„ç†

#### 3. å¤šæ¨¡æ€å¤„ç†å™¨ (`app/multimodal.py`)
- **åŠŸèƒ½**: å¤„ç†å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶ç­‰å¤šæ¨¡æ€å†…å®¹
- **ç‰¹æ€§**:
  - è‡ªåŠ¨ä¸‹è½½å’Œè½¬æ¢ URL èµ„æº
  - Base64 ç¼–ç è½¬æ¢
  - MIME ç±»å‹è¯†åˆ«
  - æ–‡ä»¶å¤§å°é™åˆ¶

#### 4. æ•°æ®æ¨¡å‹ (`app/models.py`)
- **åŠŸèƒ½**: å®šä¹‰ OpenAI å’Œ ADK æ ¼å¼çš„æ•°æ®ç»“æ„
- **ç‰¹æ€§**:
  - Pydantic æ¨¡å‹éªŒè¯
  - è‡ªåŠ¨æ ¼å¼è½¬æ¢
  - ç±»å‹å®‰å…¨

#### 5. é…ç½®ç®¡ç† (`app/config.py`)
- **åŠŸèƒ½**: ç¯å¢ƒå˜é‡å’Œé…ç½®ç®¡ç†
- **ç‰¹æ€§**:
  - ç¯å¢ƒå˜é‡åŠ è½½
  - é»˜è®¤å€¼è®¾ç½®
  - é…ç½®éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- ADK åç«¯æœåŠ¡è¿è¡Œåœ¨ `http://localhost:8000`
- è‡³å°‘ 2GB å†…å­˜

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <repository-url>
   cd adk_to_dify
   ```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
   ```bash
   python -m venv .venv
   
   # Windows
   .venv\Scripts\activate
   
   # Linux/Mac
   source .venv/bin/activate
   ```

3. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

4. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # å¤åˆ¶é…ç½®æ¨¡æ¿
   cp .env.example .env
   
   # ç¼–è¾‘é…ç½®æ–‡ä»¶
   notepad .env  # Windows
   nano .env     # Linux/Mac
   ```

5. **å¯åŠ¨æœåŠ¡**
   ```bash
   # å¼€å‘æ¨¡å¼
   python -m uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload
   
   # ç”Ÿäº§æ¨¡å¼
   python -m uvicorn app.main:app --host 0.0.0.0 --port 8080 --workers 4
   ```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶å¹¶é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```bash
# ADK åç«¯é…ç½®
ADK_HOST=http://localhost:8000          # ADK æœåŠ¡åœ°å€
ADK_APP_NAME=agent                      # é»˜è®¤åº”ç”¨åç§°

# æœåŠ¡é…ç½®
PORT=8080                               # ä¸­é—´ä»¶æœåŠ¡ç«¯å£
LOG_LEVEL=INFO                          # æ—¥å¿—çº§åˆ« (DEBUG/INFO/WARNING/ERROR)

# å¤šæ¨¡æ€é…ç½®
MAX_FILE_SIZE_MB=10                     # æœ€å¤§æ–‡ä»¶å¤§å° (MB)
DOWNLOAD_TIMEOUT=30                     # ä¸‹è½½è¶…æ—¶æ—¶é—´ (ç§’)

# API Key è®¤è¯ (å¯é€‰)
REQUIRE_API_KEY=false                   # æ˜¯å¦å¯ç”¨ API Key éªŒè¯
API_KEYS=sk-adk-middleware-key          # å…è®¸çš„ API Key åˆ—è¡¨ (é€—å·åˆ†éš”)
DEFAULT_API_KEY=sk-adk-middleware-key   # é»˜è®¤ API Key
```

### Dify é…ç½®

åœ¨ Dify ä¸­é…ç½®è‡ªå®šä¹‰æ¨¡å‹ï¼š

1. **æ¨¡å‹æä¾›å•†**: OpenAI API å…¼å®¹
2. **API Base URL**: `http://your-middleware-host:8080/v1`
3. **API Key**: `sk-adk-middleware-key` (å¦‚æœå¯ç”¨äº†è®¤è¯)
4. **æ¨¡å‹åç§°**: ä¸ ADK çš„ `appName` å¯¹åº”

## ğŸ“¡ API ä½¿ç”¨è¯´æ˜

### èŠå¤©å®Œæˆæ¥å£

**ç«¯ç‚¹**: `POST /v1/chat/completions`

#### è¯·æ±‚æ ¼å¼

```json
{
  "model": "agent",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "è¯·æè¿°è¿™å¼ å›¾ç‰‡"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "https://example.com/image.jpg"
          }
        }
      ]
    }
  ],
  "stream": true,
  "user": "user-12345",
  "temperature": 0.7
}
```

#### å“åº”æ ¼å¼

**éæµå¼å“åº”**:
```json
{
  "id": "chatcmpl-123",
  "object": "chat.completion",
  "created": 1677652288,
  "model": "agent",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "è¿™æ˜¯ä¸€å¼ ç¾ä¸½çš„é£æ™¯å›¾ç‰‡..."
      },
      "finish_reason": "stop"
    }
  ]
}
```

**æµå¼å“åº”** (SSE):
```
data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1677652288,"model":"agent","choices":[{"index":0,"delta":{"content":"è¿™"},"finish_reason":null}]}

data: {"id":"chatcmpl-123","object":"chat.completion.chunk","created":1677652288,"model":"agent","choices":[{"index":0,"delta":{"content":"æ˜¯"},"finish_reason":null}]}

data: [DONE]
```

### æ¨¡å‹åˆ—è¡¨æ¥å£

**ç«¯ç‚¹**: `GET /v1/models`

#### å“åº”æ ¼å¼
```json
{
  "object": "list",
  "data": [
    {
      "id": "agent",
      "object": "model",
      "created": 1677652288,
      "owned_by": "adk"
    }
  ]
}
```

### å¥åº·æ£€æŸ¥æ¥å£

**ç«¯ç‚¹**: `GET /v1/health`

#### å“åº”æ ¼å¼
```json
{
  "status": "ok"
}
```

## ğŸ”§ é«˜çº§é…ç½®

### å¤šæ¨¡æ€æ”¯æŒ

ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†ä»¥ä¸‹ç±»å‹çš„å†…å®¹ï¼š

1. **å›¾ç‰‡**: è‡ªåŠ¨ä¸‹è½½å¹¶è½¬æ¢ä¸º Base64
2. **è§†é¢‘**: æ”¯æŒå¸¸è§è§†é¢‘æ ¼å¼
3. **æ–‡ä»¶**: PDFã€æ–‡æ¡£ç­‰æ–‡ä»¶ç±»å‹
4. **æ–‡æœ¬ä¸­çš„ URL**: è‡ªåŠ¨è¯†åˆ«å¹¶ä¸‹è½½

### ä¼šè¯ç®¡ç†

- åŸºäº `user` å­—æ®µè‡ªåŠ¨ç”Ÿæˆ `sessionId`
- æ”¯æŒä¼šè¯æŒä¹…åŒ–
- è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç† ADK ä¼šè¯

### æ€§èƒ½ä¼˜åŒ–

- **å¼‚æ­¥å¤„ç†**: å…¨å¼‚æ­¥ I/O æ“ä½œ
- **è¿æ¥æ± **: HTTP å®¢æˆ·ç«¯è¿æ¥å¤ç”¨
- **ç¼“å­˜æœºåˆ¶**: ä¼šè¯å’Œå†…å®¹ç¼“å­˜
- **æµå¼å“åº”**: æ¨¡æ‹ŸçœŸå®æ‰“å­—æœºæ•ˆæœ

## ğŸ³ Docker éƒ¨ç½²

### ä½¿ç”¨ Docker Compose

```yaml
version: '3.8'
services:
  adk-middleware:
    build: .
    ports:
      - "8080:8080"
    environment:
      - ADK_HOST=http://adk-backend:8000
      - ADK_APP_NAME=agent
      - PORT=8080
      - REQUIRE_API_KEY=false
    depends_on:
      - adk-backend
  
  adk-backend:
    image: adk-backend:latest
    ports:
      - "8000:8000"
```

### å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—é…ç½®

```python
# æ—¥å¿—çº§åˆ«é…ç½®
LOG_LEVEL=DEBUG  # è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
LOG_LEVEL=INFO   # è¾“å‡ºä¸€èˆ¬è¿è¡Œä¿¡æ¯
LOG_LEVEL=WARNING # åªè¾“å‡ºè­¦å‘Šå’Œé”™è¯¯
```

### å…³é”®æ—¥å¿—

- **è¯·æ±‚æ—¥å¿—**: è®°å½•æ‰€æœ‰ API è¯·æ±‚
- **è½¬æ¢æ—¥å¿—**: è®°å½•æ ¼å¼è½¬æ¢è¿‡ç¨‹
- **é”™è¯¯æ—¥å¿—**: è®°å½•æ‰€æœ‰é”™è¯¯ä¿¡æ¯
- **æ€§èƒ½æ—¥å¿—**: è®°å½•å“åº”æ—¶é—´

### ç›‘æ§æŒ‡æ ‡

- API å“åº”æ—¶é—´
- é”™è¯¯ç‡ç»Ÿè®¡
- å¹¶å‘è¿æ¥æ•°
- å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
adk_to_dify/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ adk_client.py        # ADK å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ multimodal.py        # å¤šæ¨¡æ€å¤„ç†å™¨
â”‚   â”œâ”€â”€ models.py            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ auth.py              # è®¤è¯æ¨¡å—
â”œâ”€â”€ docs/                    # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ tests/                   # æµ‹è¯•ç›®å½•
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”œâ”€â”€ Dockerfile              # Docker é…ç½®
â”œâ”€â”€ docker-compose.yml      # Docker Compose é…ç½®
â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜
```

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ–°çš„æ•°æ®æ¨¡å‹**: åœ¨ `models.py` ä¸­å®šä¹‰
2. **æ–°çš„ API ç«¯ç‚¹**: åœ¨ `main.py` ä¸­æ·»åŠ 
3. **æ–°çš„è½¬æ¢é€»è¾‘**: åœ¨ `adk_client.py` ä¸­å®ç°
4. **æ–°çš„å¤„ç†æ¨¡å—**: åˆ›å»ºæ–°çš„ Python æ–‡ä»¶

### æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
python -m pytest tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•
python -m pytest tests/test_adk_client.py

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python -m pytest --cov=app tests/
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥ ADK å¤±è´¥
```
ERROR: ADK HTTP error: 503 - Service Unavailable
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ ADK æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚

#### 2. å›¾ç‰‡å¤„ç†å¤±è´¥
```
WARNING: Failed to process image URL: timeout
```
**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å›¾ç‰‡ URL æ˜¯å¦å¯è®¿é—®ï¼Œç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ã€‚

#### 3. ä¼šè¯åˆ›å»ºå¤±è´¥
```
ERROR: Failed to create ADK session: 409 Conflict
```
**è§£å†³æ–¹æ¡ˆ**: ä¼šè¯å·²å­˜åœ¨ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚

#### 4. å†…å­˜ä½¿ç”¨è¿‡é«˜
**è§£å†³æ–¹æ¡ˆ**: 
- è°ƒæ•´ `MAX_FILE_SIZE_MB` é…ç½®
- å¢åŠ å†…å­˜é™åˆ¶
- ä¼˜åŒ–å¹¶å‘è¿æ¥æ•°

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—è¿›è¡Œè°ƒè¯•ï¼š

```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8080 --log-level debug
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [æ–‡æ¡£ç›®å½•](docs/) è·å–è¯¦ç»†ä¿¡æ¯
2. æäº¤ Issue
3. è”ç³»å¼€å‘å›¢é˜Ÿ

---

**æ³¨æ„**: æœ¬ä¸­é—´ä»¶ä¸“ä¸º ADK å’Œ Dify çš„é›†æˆè®¾è®¡ï¼Œç¡®ä¿ ADK åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œæ˜¯ä½¿ç”¨çš„å‰ææ¡ä»¶ã€‚